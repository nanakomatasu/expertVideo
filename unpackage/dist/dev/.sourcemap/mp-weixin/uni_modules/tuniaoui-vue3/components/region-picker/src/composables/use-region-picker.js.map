{"version":3,"file":"use-region-picker.js","sources":["uni_modules/tuniaoui-vue3/components/region-picker/src/composables/use-region-picker.ts"],"sourcesContent":["import { nextTick, ref, watch } from 'vue'\nimport regionJsonData from '../../libs/region-data.json'\nimport { CHANGE_EVENT, UPDATE_MODEL_EVENT } from '../../../../constants'\nimport { cloneDeep } from '../../../../utils'\n\nimport type { SetupContext } from 'vue'\nimport type { RegionDataItem } from '../../libs'\nimport type {\n  RegionPickerEmits,\n  RegionPickerModelValueType,\n  RegionPickerProps,\n} from '../region-picker'\n\ntype RegionModelValueMode = 'code' | 'name'\n\nexport const useRegionPicker = (\n  porps: RegionPickerProps,\n  emits: SetupContext<RegionPickerEmits>['emit']\n) => {\n  // 列表数据\n  const pickerSelectData = regionJsonData\n\n  // 显示/隐藏地址选择器\n  const showPicker = ref(false)\n  watch(\n    () => porps.open,\n    (val) => {\n      showPicker.value = val\n    }\n  )\n  const _closePicker = () => {\n    emits('update:open', false)\n  }\n  // picker关闭事件\n  const handlePickerCloseEvent = () => {\n    _closePicker()\n    emits('close')\n  }\n\n  // 当前选中的值\n  const currentSelectValue = ref<RegionPickerModelValueType>([])\n  // 标记当前传递的值的类型\n  let userRegionValueMode: RegionModelValueMode = 'code'\n\n  // 根据name获取code\n  const getCodeByNames = (names: string[]): string[] => {\n    const code: string[] = []\n    let data: RegionDataItem[] = regionJsonData\n    do {\n      const name = names.shift()\n      const regionItem: RegionDataItem =\n        data.find((item) => item.name === name) || data[0]\n      if (regionItem) {\n        code.push(regionItem.code)\n      }\n      data = regionItem?.children || []\n    } while (data.length)\n\n    return code\n  }\n  // 根据code获取name\n  const getNameByCodes = (codes: string[]): string[] => {\n    const name: string[] = []\n    let data: RegionDataItem[] = regionJsonData\n\n    do {\n      const code = codes.shift()\n      const regionItem: RegionDataItem =\n        data.find((item) => item.code === code) || data[0]\n      if (regionItem) {\n        name.push(regionItem.name)\n      }\n      data = regionItem?.children || []\n    } while (data.length)\n\n    return name\n  }\n\n  /**\n   * 填充code\n   * @example 传递的是['44', '4401'] 返回 ['44', '4401', '440113']\n   */\n  const fillCode = (codes: string[]): string[] => {\n    const result: string[] = []\n    let data: RegionDataItem[] = regionJsonData\n    do {\n      const code = codes.shift()\n      const regionItem: RegionDataItem =\n        data.find((item) => item.code === code) || data[0]\n      if (regionItem) {\n        result.push(regionItem.code)\n      }\n      data = regionItem?.children || []\n    } while (data.length)\n\n    return result\n  }\n\n  // 标记是否内部更新\n  let isInnerUpdate = false\n  watch(\n    () => porps.modelValue,\n    (val) => {\n      if (isInnerUpdate) {\n        isInnerUpdate = false\n        return\n      }\n\n      const chineseReg = /^[\\u4E00-\\u9FA5]+$/ // 中文正则\n      const codeReg = /^\\d{2,6}$/ // 地区编码正则\n\n      if (val.length) {\n        const value = cloneDeep(val)\n        if (chineseReg.test(value[0])) {\n          userRegionValueMode = 'name'\n          currentSelectValue.value = getCodeByNames(value)\n          isInnerUpdate = true\n          emits(\n            UPDATE_MODEL_EVENT,\n            getNameByCodes(cloneDeep(currentSelectValue.value))\n          )\n        } else if (codeReg.test(value[0])) {\n          userRegionValueMode = 'code'\n          currentSelectValue.value = fillCode(value)\n          isInnerUpdate = true\n          emits(UPDATE_MODEL_EVENT, currentSelectValue.value)\n        }\n      }\n    },\n    {\n      immediate: true,\n    }\n  )\n\n  // picker发生改变回调\n  const handlePickerChangeEvent = (\n    value: string | number | (string | number)[],\n    index: number,\n    item: any\n  ) => {\n    if (userRegionValueMode === 'name') {\n      value = getNameByCodes(value as string[])\n    }\n    isInnerUpdate = true\n    emits(CHANGE_EVENT, value as string[], item)\n  }\n\n  // picker确认事件\n  const handlePickerConfirmEvent = (\n    value: string | number | (string | number)[],\n    item: any\n  ) => {\n    currentSelectValue.value = cloneDeep(value as string[])\n    if (userRegionValueMode === 'name') {\n      value = getNameByCodes(value as string[])\n    }\n    emits(UPDATE_MODEL_EVENT, value as string[])\n    nextTick(() => {\n      emits('confirm', value as string[], item)\n    })\n    _closePicker()\n  }\n\n  // picker取消事件\n  const handlePickerCancelEvent = () => {\n    _closePicker()\n    emits('cancel')\n  }\n\n  return {\n    pickerSelectData,\n    showPicker,\n    currentSelectValue,\n    handlePickerCloseEvent,\n    handlePickerChangeEvent,\n    handlePickerConfirmEvent,\n    handlePickerCancelEvent,\n  }\n}\n"],"names":["useRegionPicker","porps","emits","pickerSelectData","regionJsonData","showPicker","ref","watch","val","_closePicker","handlePickerCloseEvent","currentSelectValue","userRegionValueMode","getCodeByNames","names","code","data","name","regionItem","item","getNameByCodes","codes","fillCode","result","isInnerUpdate","chineseReg","codeReg","value","cloneDeep","UPDATE_MODEL_EVENT","index","CHANGE_EVENT","nextTick"],"mappings":"ssgGAeaA,EAAkB,CAC7BC,EACAC,IACG,CAEH,MAAMC,EAAmBC,EAGnBC,EAAaC,MAAI,EAAK,EAC5BC,EAAA,MACE,IAAMN,EAAM,KACXO,GAAQ,CACPH,EAAW,MAAQG,CACrB,CAAA,EAEF,MAAMC,EAAe,IAAM,CACzBP,EAAM,cAAe,EAAK,CAAA,EAGtBQ,EAAyB,IAAM,CACtBD,IACbP,EAAM,OAAO,CAAA,EAITS,EAAqBL,MAAgC,CAAA,CAAE,EAE7D,IAAIM,EAA4C,OAG1C,MAAAC,EAAkBC,GAA8B,CACpD,MAAMC,EAAiB,CAAA,EACvB,IAAIC,EAAyBZ,EAC1B,EAAA,CACK,MAAAa,EAAOH,EAAM,QACbI,EACJF,EAAK,KAAMG,GAASA,EAAK,OAASF,CAAI,GAAKD,EAAK,CAAC,EAC/CE,GACGH,EAAA,KAAKG,EAAW,IAAI,EAEpBF,GAAAE,GAAA,YAAAA,EAAY,WAAY,EAAC,OACzBF,EAAK,QAEP,OAAAD,CAAA,EAGHK,EAAkBC,GAA8B,CACpD,MAAMJ,EAAiB,CAAA,EACvB,IAAID,EAAyBZ,EAE1B,EAAA,CACK,MAAAW,EAAOM,EAAM,QACbH,EACJF,EAAK,KAAMG,GAASA,EAAK,OAASJ,CAAI,GAAKC,EAAK,CAAC,EAC/CE,GACGD,EAAA,KAAKC,EAAW,IAAI,EAEpBF,GAAAE,GAAA,YAAAA,EAAY,WAAY,EAAC,OACzBF,EAAK,QAEP,OAAAC,CAAA,EAOHK,EAAYD,GAA8B,CAC9C,MAAME,EAAmB,CAAA,EACzB,IAAIP,EAAyBZ,EAC1B,EAAA,CACK,MAAAW,EAAOM,EAAM,QACbH,EACJF,EAAK,KAAMG,GAASA,EAAK,OAASJ,CAAI,GAAKC,EAAK,CAAC,EAC/CE,GACKK,EAAA,KAAKL,EAAW,IAAI,EAEtBF,GAAAE,GAAA,YAAAA,EAAY,WAAY,EAAC,OACzBF,EAAK,QAEP,OAAAO,CAAA,EAIT,IAAIC,EAAgB,GACpBjB,OAAAA,EAAA,MACE,IAAMN,EAAM,WACXO,GAAQ,CACP,GAAIgB,EAAe,CACDA,EAAA,GAChB,MACF,CAEA,MAAMC,EAAa,qBACbC,EAAU,YAEhB,GAAIlB,EAAI,OAAQ,CACR,MAAAmB,EAAQC,YAAUpB,CAAG,EACvBiB,EAAW,KAAKE,EAAM,CAAC,CAAC,GACJf,EAAA,OACHD,EAAA,MAAQE,EAAec,CAAK,EAC/BH,EAAA,GAChBtB,EACE2B,EAAA,mBACAT,EAAeQ,EAAA,UAAUjB,EAAmB,KAAK,CAAC,CAAA,GAE3Ce,EAAQ,KAAKC,EAAM,CAAC,CAAC,IACRf,EAAA,OACHD,EAAA,MAAQW,EAASK,CAAK,EACzBH,EAAA,GACVtB,EAAA2B,EAAA,mBAAoBlB,EAAmB,KAAK,EAEtD,CACF,EACA,CACE,UAAW,EACb,CAAA,EAsCK,CACL,iBAAAR,EACA,WAAAE,EACA,mBAAAM,EACA,uBAAAD,EACA,wBAvC8B,CAC9BiB,EACAG,EACAX,IACG,CACCP,IAAwB,SAC1Be,EAAQP,EAAeO,CAAiB,GAE1BH,EAAA,GACVtB,EAAA6B,EAAA,aAAcJ,EAAmBR,CAAI,CAAA,EA+B3C,yBA3B+B,CAC/BQ,EACAR,IACG,CACgBR,EAAA,MAAQiB,YAAUD,CAAiB,EAClDf,IAAwB,SAC1Be,EAAQP,EAAeO,CAAiB,GAE1CzB,EAAM2B,EAAAA,mBAAoBF,CAAiB,EAC3CK,EAAAA,WAAS,IAAM,CACP9B,EAAA,UAAWyB,EAAmBR,CAAI,CAAA,CACzC,EACYV,GAAA,EAgBb,wBAZ8B,IAAM,CACvBA,IACbP,EAAM,QAAQ,CAAA,CAUd,CAEJ"}